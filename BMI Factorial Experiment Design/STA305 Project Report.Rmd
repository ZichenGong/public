---
title: "Factorial Experiment Design on Key Factors Affecting BMI "
author: "Zichen Gong 1005682469"
date: "08/04/2022"
output: pdf_document
fontsize: 10pt
---

# Introduction

The objective of this experiment is to investigate whether factors potentially leading to heart disease will affect each other. More specifically, **either one of kidney disease, smoking behavior, alcohol-drinking behavior, physical activity and sleep time or an interaction between them collectively are going to affect Body Mass Index (BMI), using an unreplicated $2^5$ factorial experiment with 2 blocks and highest order interaction with blocks**. BMI is a good indicator of obesity which is a potential threat over people's health status [1]. Although there is minor difference of BMI standard between men and women, a BMI of 22 is ideal overall. If we manage to prove that some factors will affect BMI, this means that the probability of heart disease for people who have these symptoms/behaviors can be even higher or lower indicated by these effects. 

# Materials and Methods

## Experimental Design and Data

The dataset used for this experiment is composed of a binary variable indicating whether one observation has heart disease or not, and a set of other variables, either numerical or descriptive, indicating potential factors that are highly associated with heart disease [5]. This data originally comes from Centers for Disease Control and Prevention (CDC), collected via telephone surveys from U.S. residents belonging to the Behavioral Risk Factor Surveillance System (BRFSS). Established in year 1984, the most recently modified version we used for this experiment, including data from year 2020, is updated in year 2022, consisting of 401958 rows and 279 columns. Pytlak selected the most relevant factors, and so right not the dataset consists of 319795 observations and 23 columns.

In this design, there are five factors under investigation in total: four binary variables indicating whether one observation has kidney disease or not (factor A), whether the observation smokes or not (factor B), whether the observation drinks alcohol or not (factor C), whether the observation practices physical activities or not (factor D), and one numerical variable indicating sleep time of the observation (factor E). 

An unreplicated factorial design experiment using blocking and confounding is implemented. Due to limited resource and time consuming concern, a $2^5$ factorial design, which contains 32 treatment combinations is not realistic. If so, this means we need to run 5 main factors, 10 two-factor interactions, 10 three-factor interactions, 5 four-factor interactions and 1 five-factor interaction. It takes time to find people with certain combinations of symptoms/behaviors. Even if using existed observations in the dataset, not everyone is willing to accept follow-up telephone surveys.

Instead, we split each factor into two levels, high level and low level. Observations with high level under one specific factor are marked as 1, while those with low level are marked as -1. For factor kidney disease, observations that have kidney disease are marked as 1, and those who do not have are marked as -1. For factor smoking behavior, observations that smoke are marked as 1, and those who do not smoke are marked as -1. For factor alcohol-drinking behavior, observations that drink alcohol are marked as 1, and those who do not drink are marked as -1. For factor physical activity, observations who do physical activities are marked as 1, and those who do not are marked as -1. For factor sleep time, observations that sleep greater than or equal to 7 hours per day are marked as 1, and those who do not meet this standard are marked as -1. The recommended range of sleep time for adults is within 7 to 9 hours, inclusive [3]. That is why I choose 7h/day as the threshold of dividing high and low levels for the factor sleep time. 

When we confound with the highest interaction term, $\alpha_1 = \alpha_2 = \alpha_3 = \alpha_4 = \alpha_5 = 1$, the highest order interaction turns out to be $A^{\alpha_1}B^{\alpha_2}C^{\alpha_3}D^{\alpha_4}E^{\alpha_5} = ABCDE$. $L = \alpha_1 x_1 + \alpha_2 x_2 + \alpha_3 x_3 + \alpha_4 x_4 + \alpha_5 x_5$ gives $L = x_1 + x_2 + x_3 + x_4 + x_5$. $x_i$s are binary. If it is high level, $x_i = 1$. Or if it is low level, $x_i = 0$. For $\text{L mod (2)} = 0$, it is assigned to Block 1. For $\text{L mod (2)} = 1$, it is assigned to Block 2. Instead of running a total of 32 treatment combinations, I can choose either one of the two blocks. 

For the factorial design, I need to pick 32 matched observations without partial aliasing. I first create a $2^5$ factorial design without randomization using `FrF2()`. Then I pair it up with the original dataset after high level and low level cleaning. Only observations with matched factors observations are kept, and replicated observations are removed. Only 32 observations left at last. 

## Statistical Analysis

The effect model of this experiment is $\mu_{abcde} = \mu + \tau_a + ... + \tau_e + \tau_{ab} + ... + \tau_{de} + ... + \tau_{abc} + ... + \tau_{cde} + \tau_{abcd} + ... + \tau_{bcde} + \tau_{abcde}$. $\mu$ is the general mean. $\tau_a ... \tau_{abcde}$ are main effects and interactions. The null hypothesis is $\tau_a = ... = \tau_e = 0$ for main effects and $\tau_{ab} = ... = \tau_{bcde} = \tau_{abcde} = 0$ for interactions. The alternative hypothesis in this case is at least one of these effects is not equal to 0. 

This experiment uses Anova test and Daniel plot to decide whether we should keep some active effects and interactions and which of them are statistically significant.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
mydata <- read.csv("heart_2020_cleaned.csv")
```

```{r, include=FALSE}
# Uncomment the following lines if you do not have this package
# install.package(dplyr)
# install.package(knitr)
# install.package(FrF2)
# install.package(car)
library(dplyr)
library(knitr)
library(FrF2)
library(car)
```

```{r, include=FALSE}
# Data Cleaning

# Assign KidneyDisease as factor A
# Assign Smoking as factor B
# Assign AlcoholDrinking as factor C
# Assign PhysicalActivity as factor D
# Assign SleepTime as factor E
# Assign BMI as response variable Y
mydata$A = ifelse(mydata$KidneyDisease == "Yes", 1, -1)
mydata$B = ifelse(mydata$Smoking == "Yes", 1, -1)
mydata$C = ifelse(mydata$AlcoholDrinking == "Yes", 1, -1)
mydata$D = ifelse(mydata$PhysicalActivity == "Yes", 1, -1)
mydata$E = ifelse(mydata$SleepTime >= 7, 1, -1)

df <- mydata %>%
  select(BMI, A, B, C, D, E)

L <- ((df$A == 1) + (df$B == 1) + (df$C == 1) + (df$D == 1) + (df$E == 1)) %% 2

df$block = ifelse(L == 0, 1, 2)
```

```{r, include=FALSE}
# Select 32 observations
full <- FrF2(32, nfactors=5, 
             factor.names = c("A", "B", "C", "D", "E"), randomize = FALSE)
full.exp <- data.frame(full)
pair <- merge(full.exp, df, by = c("A", "B", "C", "D", "E"))
experiment <- unique(pair[ , 1:5])
i <- rownames(experiment)
pair <- pair %>% filter(row_number() %in% i)
```

```{r, include=FALSE}
block_1 <- pair %>%
  filter(block == 1) %>%
  select(A, B, C, D, E, BMI)
block_2 <- pair %>%
  filter(block == 2) %>%
  select(A, B, C, D, E, BMI)
mean(block_1$BMI)
mean(block_2$BMI)
```

```{r, include=FALSE}
# Fit model

model <- lm(BMI ~ A * B * C * D * E, data = pair)
anv_model <- anova(model)
```

```{r, echo=FALSE}
reg_coef <- round(model$coefficients, 2)
effect_est <- round(2 * model$coefficients, 2)
sum_sq <- round(anv_model$`Sum Sq`, 2)
contribution <- round(anv_model$`Sum Sq` / 
                        sum(anv_model$`Sum Sq`) * 100, 2)
table_1 <- data.frame(reg_coef, effect_est, sum_sq, contribution)
kable(table_1, col.names = c("Regression Coefficient", "Effect Estimate", 
                             "Sum of Squares", "Percent Contribution"), 
      align = "cccc", 
      caption = "Table 1: Effect Estimates for the Blocked 2^5 Design")
```

The coefficient estimates generated via Anova, the effect estimates, sum of squares and the percent contribution of each sum of square is demonstrated on Table 1. The effect estimates of main effects, 2-factor to 4-factor interactions should be identical to the effect estimates without block effects. If we briefly take a look at coefficient estimates, main effect E, interaction effect between ABC, interaction effect between ABD, and interaction effect between ABCD all have larger absolute values, indicating that they might be important. 

In this experiment, the interaction estimate of highest order interaction ABCDE is the sum of the original interaction effect and the block. It is also equal to the block effect, which can be calculated through the difference between means of response variables for 2 blocks. The block effect is $\bar{BMI}_{\text{block 1}} - \bar{BMI}_{\text{block 2}} = 32.41 - 29.13 = 3.28$. In other words, block effect is equal to the sum of interaction effect and the block.

```{r, include=FALSE}
DanielPlot(model, half = FALSE, autolab = FALSE)
```

# Results and Discussion

```{r, echo=FALSE}
# model after screening
finalmodel <- lm(BMI ~ E + A*B*C + A*B*D + A*B*C*D, data = pair)
finalanv <- anova(finalmodel)
kable(finalanv, col.names = c("Degree of Freedom", "Sum of Squares",
                              "Mean Square", "F Value", "P Value"),
      align = "ccccc", 
      caption = "Table 2: Analysis of Variance")
```

After consulting via Daniel plot, I pick main effect E, interaction effect between ABC, interaction effect between ABD, and interaction effect between ABCD as the final effect terms. This fits what we observed from Table 1. The normality assumption and constant variance assumption of residuals are verified. 

If we take a significance level of $\alpha = 0.1$, based on Table 2, the final Anova output, main effect E, interaction effect between ABC, interaction effect between ABD, interaction effect between ABCD all have enough evidence to reject the null hypothesis. This indicates that, sleep time itself, interaction between kidney disease, smoking and alcohol drinking behavior, interaction between kidney disease, smoking and physical activity, and interaction between kidney disease, smoking, drinking alcohol and physical activity, all have strong effects on BMI.

```{r, include=FALSE}
qqPlot(finalmodel$residuals, main = "QQ Plot", ylab = "Residuals")
plot(finalmodel$fitted.values, finalmodel$residuals, 
     main = "Heterogeneity of Error Variances Check",
     xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0)
```

## Conclusion

Using an unreplicated $2^5$ factorial design experiment with 2 blocks and the highest order interaction confounded, we manage to find out that the main factor sleep time,  the interaction effect between whether people have kidney disease, smoke and drink alcohol, the interaction effect between whether people have kidney disease, smoke and do physical activity, and the interaction effect between whether people have kidney disease, smoke, drink alcohol and do physical activity all have strong enough evidence to affect people's BMI. We can design further studies investigating how solid these effects are. For a model predicting heart disease, if the model consists of these factors and BMI at the same time, with careful calculation, we might consider removing BMI from the model for simplicity.

# References

1. Are BMI charts different for men & women? (2019). Retrieved April 2, 2022, from [https://gasparinutrition.com/blogs/fitness-facts/are-bmi-charts-different-for-men-women#:~:text=Recent%20studies%20have%20found%20that,21%20for%20women%20is%20healthy.](https://gasparinutrition.com/blogs/fitness-facts/are-bmi-charts-different-for-men-women#:~:text=Recent%20studies%20have%20found%20that,21%20for%20women%20is%20healthy.)

2. Hadley Wickham, Romain François, Lionel Henry and Kirill Müller (2022). dplyr: A Grammar of Data Manipulation. R package version 1.0.8. [https://CRAN.R-project.org/package=dplyr](https://CRAN.R-project.org/package=dplyr) (Last Accessed: April 3, 2022)

3. How Much Sleep Do I Need? (2017). Retrieved April 2, 2022, from [https://www.cdc.gov/sleep/about_sleep/how_much_sleep.html](https://www.cdc.gov/sleep/about_sleep/how_much_sleep.html)

4. John Fox and Sanford Weisberg (2019). An {R} Companion to Applied Regression, Third Edition. Thousand Oaks CA: Sage. URL: [https://socialsciences.mcmaster.ca/jfox/Books/Companion/](https://socialsciences.mcmaster.ca/jfox/Books/Companion/) (Last Accessed: April 3, 2022)

5. Kaggle. (2022). *Personal Key Indicators of Heart Disease* [Data file]. Retrieved April 2, 2022, from [https://www.kaggle.com/datasets/kamilpytlak/personal-key-indicators-of-heart-disease](https://www.kaggle.com/datasets/kamilpytlak/personal-key-indicators-of-heart-disease)

6. R Core Team (2021). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL [https://www.R-project.org/](https://www.R-project.org/) (Last Accessed: April 3, 2022)

7. Ulrike Gr"omping (2014). R Package FrF2 for Creating and Analyzing Fractional Factorial 2-Level Designs. Journal of Statistical Software, 56(1), 1-56. URL [http://www.jstatsoft.org/v56/i01/](http://www.jstatsoft.org/v56/i01/) (Last Accessed: April 3, 2022)

8. Yihui Xie (2021). knitr: A General-Purpose Package for Dynamic Report Generation in R. R package version 1.37. (Last Accessed: April 3, 2022)

The report is constructed using `R-4.1.2`.